# Testing Guide - Cart, Payment, Review Integration

## ‚úÖ Completed Integrations

### 1. ProductDetail - Cart Integration ‚úÖ

**Location:** `src/pages/ProductDetail.tsx`

**Features Implemented:**
- ‚úÖ Quantity selector with stock limit validation
- ‚úÖ Add to Cart button uses:
  - `cartApi.addOneToCart()` when quantity = 1
  - `cartApi.addMultipleToCart()` when quantity > 1
- ‚úÖ Buy Now button adds to cart + navigates to `/cart`
- ‚úÖ Disabled buttons for inactive or out-of-stock products
- ‚úÖ Review section with ReviewForm and ReviewList components

**Testing Steps:**

1. **Navigate to any book detail page:**
   ```
   http://localhost:5175/book/1/book-title
   ```

2. **Test Add to Cart with quantity = 1:**
   - Set quantity to 1
   - Click "Add to Cart"
   - Should see success message
   - Check Network tab ‚Üí POST `/api/carts/myCart/add-1-to-cart`

3. **Test Add to Cart with quantity > 1:**
   - Set quantity to 5
   - Click "Add to Cart"
   - Should see success message
   - Check Network tab ‚Üí POST `/api/carts/myCart/add-multiple-to-cart`
   - Body should contain: `{ bookId: 1, quantity: 5 }`

4. **Test Buy Now:**
   - Set quantity to 3
   - Click "Buy Now"
   - Should add to cart and redirect to `/cart`

5. **Test Disabled States:**
   - Try inactive book ‚Üí Button shows "Unavailable"
   - Try out-of-stock book ‚Üí Button shows "Out of Stock"
   - Both buttons should be disabled (gray, not clickable)

---

### 2. Cart Page - VNPay Payment ‚úÖ

**Location:** `src/components/Cart/Cart.tsx`

**Features Implemented:**
- ‚úÖ "Place Order" button (original checkout flow)
- ‚úÖ "Pay with VNPay" button with payment API integration
- ‚úÖ Loading state during payment creation
- ‚úÖ Automatic redirect to VNPay payment gateway

**Testing Steps:**

1. **Navigate to cart page:**
   ```
   http://localhost:5175/cart
   ```

2. **Add some items to cart** (from product detail pages)

3. **Test VNPay Payment:**
   - Click "üí≥ Pay with VNPay" button
   - Button should show loading spinner
   - Check Network tab ‚Üí GET `/api/payments/create`
   - Query params should include:
     - `amount`: Total in cents (e.g., 50000 for $500.00)
     - `orderInfo`: "Thanh toan don hang BookVerse - X items"
   - Should redirect to VNPay payment URL

4. **After VNPay redirect:**
   - Complete payment on VNPay test site
   - VNPay will redirect back to: `/payment/vnpay-return?vnp_Amount=...`
   - Should see payment invoice/receipt
   - Invoice shows:
     - Transaction number
     - Amount paid
     - Bank code
     - Bank transaction number
     - Payment date/time
     - Order info
     - Status (Success/Failed)

5. **Test Empty Cart:**
   - Remove all items from cart
   - Click "Pay with VNPay"
   - Should see alert: "Your cart is empty!"

---

### 3. Review System ‚úÖ

**Location:** `src/pages/ProductDetail.tsx`

**Components Used:**
- `ReviewForm` - Star rating + comment form
- `ReviewList` - Display all reviews with average rating

**Features Implemented:**
- ‚úÖ "Write a Review" button for CUSTOMER users
- ‚úÖ Star rating selector (1-5 stars, required)
- ‚úÖ Comment textarea (optional)
- ‚úÖ Review list with average rating display
- ‚úÖ Delete own reviews (customers)
- ‚úÖ Delete any reviews (admin/staff)
- ‚úÖ Auto-refresh after submit

**Testing Steps:**

1. **View Reviews (Logged out):**
   - Go to any book detail page
   - Scroll to "Customer Reviews" section
   - Should see existing reviews (if any)
   - Should see message: "Sign in to write a review"

2. **Write Review (Logged in as CUSTOMER):**
   - Sign in as customer
   - Go to book detail page
   - Click "‚úçÔ∏è Write a Review" button
   - ReviewForm should appear:
     - Star rating selector (hover effect)
     - Comment textarea
     - Submit and Cancel buttons
   - Select rating (e.g., 4 stars)
   - Enter comment (optional)
   - Click "Submit Review"
   - Check Network tab ‚Üí POST `/api/reviews/create`
   - Body: `{ bookId: 1, rating: 4, comment: "Great book!" }`
   - Should see success message
   - Form should close
   - Review list should refresh automatically

3. **Update Review:**
   - Click "Write a Review" again
   - If user already has review, form should show existing data
   - Change rating or comment
   - Click "Submit"
   - Check Network tab ‚Üí PUT `/api/reviews/update`

4. **Delete Own Review:**
   - Find your review in the list
   - Should see "Delete" button (marked as "You")
   - Click "Delete"
   - Confirm deletion
   - Check Network tab ‚Üí DELETE `/api/reviews/myReview/{bookId}`
   - Review should disappear from list

5. **Admin/Staff Delete:**
   - Sign in as admin or staff
   - Go to book with reviews
   - Should see "Delete" button on ALL reviews
   - Click "Delete" on any review
   - Check Network tab ‚Üí DELETE `/api/reviews/deleteByAdminStaff/{bookId}`

6. **Review Display Features:**
   - Average rating shown at top (e.g., "4.5")
   - Star visualization
   - Total review count
   - Each review shows:
     - Username
     - Date
     - Star rating
     - Comment
     - "You" badge for own reviews

---

### 4. Promotion Management ‚úÖ

**Location:** `src/components/Admin/PromotionManagement.tsx`

**Route:** `/admin/promotions`

**Features Implemented:**
- ‚úÖ List all promotions in table
- ‚úÖ Filter: Show/Hide inactive promotions
- ‚úÖ Toggle active/inactive status
- ‚úÖ Status badges (Active/Upcoming/Expired/Inactive)
- ‚úÖ Display discount %, dates, description

**Testing Steps:**

1. **Access Promotion Management:**
   - Sign in as admin
   - Navigate to: `http://localhost:5175/admin/promotions`
   - Or click "Qu·∫£n l√Ω khuy·∫øn m√£i" in admin sidebar

2. **View Promotions Table:**
   - Should see table with columns:
     - ID
     - Promotion Name
     - Discount (e.g., -50%)
     - Time Period (start ‚Üí end date)
     - Status badge
     - Actions (Edit, Toggle)

3. **Filter Promotions:**
   - Check "Hi·ªÉn th·ªã khuy·∫øn m√£i ƒë√£ t·∫Øt" checkbox
   - Should show both active and inactive promotions
   - Uncheck to hide inactive ones

4. **Status Badge Colors:**
   - Green "ƒêang ho·∫°t ƒë·ªông" - Active and within date range
   - Yellow "Ch∆∞a b·∫Øt ƒë·∫ßu/ƒê√£ h·∫øt h·∫°n" - Active but outside date range
   - Gray "ƒê√£ t·∫Øt" - Inactive

5. **Toggle Promotion Status:**
   - Find active promotion
   - Click "T·∫Øt" button
   - Check Network tab ‚Üí PUT `/api/promotions/inactive/{id}`
   - Status should change to "ƒê√£ t·∫Øt"
   - Button changes to "B·∫≠t"
   - Click "B·∫≠t" to reactivate
   - Check Network tab ‚Üí PUT `/api/promotions/active/{id}`

6. **Create New Promotion (Placeholder):**
   - Click "+ T·∫°o khuy·∫øn m√£i m·ªõi" button
   - Note: Currently just a placeholder
   - TODO: Implement create/edit modal

---

## üîç API Endpoints to Monitor

### Cart API
```
POST /api/carts/myCart/add-1-to-cart
  Body: { bookId: number }

POST /api/carts/myCart/add-multiple-to-cart
  Body: { bookId: number, quantity: number }
```

### Payment API
```
GET /api/payments/create
  Params: amount, orderInfo, returnUrl?
  Response: { paymentUrl: string }

GET /api/payments/vnpay-return
  Params: vnp_Amount, vnp_BankCode, vnp_BankTranNo, 
          vnp_PayDate, vnp_OrderInfo, vnp_ResponseCode, 
          vnp_TransactionNo
  Response: PaymentRecord
```

### Review API
```
GET /api/reviews/{bookId}
  Response: ReviewResponse[]

POST /api/reviews/create
  Body: { bookId: number, rating: number, comment?: string }
  Response: ReviewResponse

PUT /api/reviews/update
  Body: { bookId: number, rating?: number, comment?: string }
  Response: ReviewResponse

DELETE /api/reviews/myReview/{bookId}
  Response: void

DELETE /api/reviews/deleteByAdminStaff/{bookId}
  Response: void
```

### Promotion API
```
GET /api/promotions
  Response: PromotionResponse[]

GET /api/promotions/active
  Response: PromotionResponse[]

PUT /api/promotions/inactive/{id}
  Response: PromotionResponse

PUT /api/promotions/active/{id}
  Response: PromotionResponse
```

---

## ‚ö†Ô∏è Known Issues & Notes

1. **VNPay Amount Format:**
   - Backend expects amount in VND (not cents)
   - Frontend multiplies by 100: `Math.round(total * 100)`
   - Example: $500.00 ‚Üí 50000 (sent to backend)

2. **Review Backend Note:**
   - Delete endpoints use `bookId` (not review ID)
   - Users can only have 1 review per book
   - Update overwrites existing review

3. **Promotion Status Logic:**
   - Active badge only shows when:
     - `active = true` AND
     - Current date between `startDate` and `endDate`

4. **Cart Context:**
   - Still uses localStorage for immediate UI updates
   - API calls sync with backend
   - Both `addToCart` (context) and `cartApi` are called

---

## ‚úÖ Testing Checklist

### Cart Integration
- [ ] Quantity = 1 calls `add-1-to-cart`
- [ ] Quantity > 1 calls `add-multiple-to-cart`
- [ ] Buy Now adds to cart and redirects
- [ ] Disabled buttons for inactive/out-of-stock
- [ ] Quantity selector respects stock limit

### Payment Flow
- [ ] VNPay button shows in cart
- [ ] Payment URL created successfully
- [ ] Redirects to VNPay
- [ ] Return URL processes correctly
- [ ] Invoice displays all payment details
- [ ] Success/failure states work

### Review System
- [ ] Can view reviews (logged out)
- [ ] Can write review (customer)
- [ ] Star rating required
- [ ] Comment optional
- [ ] Can update own review
- [ ] Can delete own review
- [ ] Admin can delete any review
- [ ] List refreshes after changes
- [ ] Average rating calculated correctly

### Promotion Management
- [ ] Table displays all promotions
- [ ] Filter works (show/hide inactive)
- [ ] Status badges correct colors
- [ ] Toggle active/inactive works
- [ ] Dates formatted correctly
- [ ] Discount percentage displayed

---

## üéØ Next Implementation Tasks

1. **Create/Edit Promotion Modal**
   - Form with fields: name, description, discount%, dates, sub-categories
   - Validation for required fields
   - Date pickers for start/end dates

2. **Simple-datatables Integration**
   - Add to PromotionManagement table
   - Add to existing management tables
   - Features: sorting, filtering, pagination, export

3. **Apply Promotions to Books**
   - Display discounted prices on book cards
   - Show "Save X%" badges
   - Calculate discount based on sub-category

4. **Order History Integration**
   - Link payments to orders
   - Show payment status in order history
   - Payment receipt download

---

## üìù Testing Results Template

```
Feature: [Cart/Payment/Review/Promotion]
Browser: [Chrome/Firefox/Edge]
User Role: [Customer/Admin/Staff/Guest]

Test Case: 
Expected Result: 
Actual Result: 
Status: [‚úÖ PASS / ‚ùå FAIL]
Screenshots: 
Notes: 
```
